# CATERING PRO - Proje BaÄŸlamÄ± ve GeliÅŸtirme KurallarÄ±

## ğŸ¯ Proje Ã–zeti
HazÄ±r yemek sektÃ¶rÃ¼ iÃ§in kurumsal iÅŸ yÃ¶netim sistemi (ERP-benzeri). ~10 aktif kullanÄ±cÄ± hedefleniyor.

## ğŸ—ï¸ Teknoloji YÄ±ÄŸÄ±nÄ±

### Backend
- **Runtime:** Node.js + Express.js
- **Module System:** ES Modules (import/export)
- **Database:** PostgreSQL (Supabase hosted)
- **ORM:** Raw SQL (pg driver)
- **AI:** Gemini API (dÃ¶kÃ¼man analizi) + Claude API (asistan)
- **Auth:** JWT + bcrypt (custom implementation)
- **Logging:** Winston
- **Port:** 3001

### Frontend
- **Framework:** Next.js 15 (App Router)
- **UI:** Mantine 7.17 + @tabler/icons-react
- **State:** React hooks + React Query (@tanstack/react-query)
- **Auth:** Custom AuthContext (JWT + localStorage)
- **Port:** 3000

### Deployment
- **Platform:** DigitalOcean Droplet (Ubuntu 22.04)
- **Domain:** https://catering-tr.com
- **DNS/CDN:** Cloudflare
- **SSL:** Cloudflare Flexible
- **Process Manager:** PM2
- **Reverse Proxy:** Nginx
- **Storage:** Supabase Storage / local uploads

---

## ğŸ“ Proje YapÄ±sÄ±

```
CATERÄ°NG/
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ routes/          # API endpoints (RESTful)
â”‚       â”œâ”€â”€ services/        # Business logic
â”‚       â”œâ”€â”€ scraper/         # ihalebul.com scraper
â”‚       â”œâ”€â”€ migrations/      # SQL migration dosyalarÄ±
â”‚       â”œâ”€â”€ middleware/      # Auth, logging middleware
â”‚       â”œâ”€â”€ utils/           # Logger, helpers
â”‚       â”œâ”€â”€ database.js      # DB connection pool
â”‚       â””â”€â”€ server.js        # Express app entry
â”œâ”€â”€ frontend/
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ app/             # Next.js App Router pages
â”‚       â”‚   â”œâ”€â”€ tenders/     # Ä°hale listesi
â”‚       â”‚   â”œâ”€â”€ tracking/    # Ä°hale takip
â”‚       â”‚   â”œâ”€â”€ ihale-uzmani/# Ä°hale uzmanÄ± modal
â”‚       â”‚   â”œâ”€â”€ muhasebe/    # Muhasebe modÃ¼lÃ¼
â”‚       â”‚   â”œâ”€â”€ planlama/    # Ãœretim planlama
â”‚       â”‚   â”œâ”€â”€ ai-chat/     # AI asistan
â”‚       â”‚   â”œâ”€â”€ admin/       # YÃ¶netim paneli
â”‚       â”‚   â”œâ”€â”€ ayarlar/     # Sistem ayarlarÄ±
â”‚       â”‚   â”œâ”€â”€ profil/      # KullanÄ±cÄ± profili
â”‚       â”‚   â”œâ”€â”€ upload/      # Dosya yÃ¼kleme
â”‚       â”‚   â””â”€â”€ giris/       # Login sayfasÄ±
â”‚       â”œâ”€â”€ components/      # Reusable UI components
â”‚       â”œâ”€â”€ context/         # AuthContext
â”‚       â”œâ”€â”€ hooks/           # Custom React hooks (React Query)
â”‚       â”œâ”€â”€ lib/             # Utility functions + API config
â”‚       â””â”€â”€ types/           # TypeScript types
â””â”€â”€ database/
    â””â”€â”€ migrations/          # Versiyonlu SQL
```

---

## ğŸ—ƒï¸ VeritabanÄ± ÅemasÄ± (Ana Tablolar)

### Ä°hale ModÃ¼lÃ¼
- `tenders` - Ä°hale kayÄ±tlarÄ± (external_id, title, tender_date, city, estimated_cost)
- `documents` - Ä°hale dÃ¶kÃ¼manlarÄ± + AI analiz sonuÃ§larÄ±
- `tender_tracking` - Ä°hale takip kayÄ±tlarÄ±
- `scraper_logs` - Scraper Ã§alÄ±ÅŸma loglarÄ±

### Muhasebe ModÃ¼lÃ¼
- `cariler` - MÃ¼ÅŸteri/TedarikÃ§i (tip, unvan, vergi_no, borc, alacak, bakiye)
- `invoices` - Faturalar
- `gelir_giderler` - Gelir/gider kayÄ±tlarÄ±
- `kasa_banka_hesaplari` - Nakit hesaplar
- `kasa_banka_hareketleri` - Para hareketleri
- `stok_kartlari` - ÃœrÃ¼n/malzeme kartlarÄ±
- `stok_hareketleri` - Stok giriÅŸ/Ã§Ä±kÄ±ÅŸ

### HR/Bordro ModÃ¼lÃ¼
- `personeller` - Ã‡alÄ±ÅŸan bilgileri (tc_kimlik, ad, soyad, maas, ise_giris_tarihi)
- `personel_odemeleri` - MaaÅŸ Ã¶demeleri
- `bordro` - AylÄ±k bordro kayÄ±tlarÄ±
- `izinler` - Ä°zin takibi
- `tazminatlar` - KÄ±dem/ihbar hesaplamalarÄ±

### Planlama ModÃ¼lÃ¼
- `receteler` - Yemek reÃ§eteleri
- `menuler` - GÃ¼nlÃ¼k/haftalÄ±k menÃ¼ler
- `projeler` - MÃ¼ÅŸteri projeleri (ihaleler)
- `sartnameler` - Gramaj ÅŸartnameleri

### Sistem
- `users` - KullanÄ±cÄ±lar (email, password, role, user_type)
- `permissions` - Yetki tanÄ±mlarÄ±
- `user_permissions` - KullanÄ±cÄ± yetkileri
- `audit_logs` - Ä°ÅŸlem loglarÄ±
- `ai_memory` - AI konuÅŸma hafÄ±zasÄ±

---

## ğŸ”§ GeliÅŸtirme KurallarÄ±

### Kod Stili
1. **Backend:** ES Modules (import/export), async/await
2. **Frontend:** TypeScript, functional components
3. **SQL:** Parameterized queries ($1, $2...), injection korumasÄ±
4. **Hata YÃ¶netimi:** try-catch + meaningful error messages

### Backend Route YapÄ±sÄ±
```javascript
// âœ… DOÄRU - ES Modules
import express from 'express';
import { query } from '../database.js';

const router = express.Router();

router.get('/', async (req, res) => {
  try {
    const result = await query('SELECT * FROM table');
    res.json({ success: true, data: result.rows });
  } catch (error) {
    res.status(500).json({ success: false, error: error.message });
  }
});

export default router;
```

### Mantine UI KullanÄ±mÄ±
```typescript
// âœ… DOÄRU - Mantine bileÅŸenleri
import { Button, Paper, Text, Stack, Group, Badge } from '@mantine/core';
import { notifications } from '@mantine/notifications';
import { IconSearch, IconPlus, IconTrash } from '@tabler/icons-react';

// Gradient butonlar
<Button variant="gradient" gradient={{ from: 'violet', to: 'blue' }}>
  Kaydet
</Button>

// Notification
notifications.show({
  title: 'BaÅŸarÄ±lÄ±',
  message: 'Ä°ÅŸlem tamamlandÄ±',
  color: 'green'
});
```

### React Query KullanÄ±mÄ±
```typescript
// âœ… DOÄRU - React Query hook'larÄ±
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';

// Data fetching
const { data, isLoading, error } = useQuery({
  queryKey: ['cariler'],
  queryFn: () => fetch(`${API_BASE_URL}/api/cariler`).then(r => r.json()),
});

// Mutation
const mutation = useMutation({
  mutationFn: (data) => fetch(...),
  onSuccess: () => queryClient.invalidateQueries({ queryKey: ['cariler'] })
});
```

### API TasarÄ±mÄ±
```javascript
// Standard response format
{ success: true, data: {...} }
{ success: false, error: "Hata mesajÄ±" }

// Pagination
GET /api/endpoint?page=1&limit=20

// Filtering
GET /api/tenders?city=Ankara&status=active
```

### VeritabanÄ± KurallarÄ±
1. Migration dosyalarÄ±: `XXX_aciklama.sql` (sÄ±ralÄ± numara)
2. Foreign key'ler: `ON DELETE CASCADE` veya `SET NULL`
3. Tarih alanlarÄ±: `TIMESTAMP` veya `DATE`
4. Para alanlarÄ±: `DECIMAL(15,2)`
5. Trigger'lar: Bakiye/miktar otomatik gÃ¼ncelleme

### Frontend KurallarÄ±
1. Pages: `app/modul/page.tsx`
2. Components: `components/ModulAdi/ComponentAdi.tsx`
3. API calls: fetch + try-catch veya React Query
4. Loading states: Her async iÅŸlemde
5. **API URL:** Mutlaka `API_BASE_URL` kullan (config'den import et)

### ğŸŒ API URL KullanÄ±mÄ± (Ã–NEMLÄ°!)

**ASLA hardcoded URL kullanma:**
```typescript
// âŒ YANLIÅ - Hardcoded URL
const API_URL = 'http://localhost:3001/api';
fetch('http://localhost:3001/api/cariler');

// âŒ YANLIÅ - process.env direkt kullanÄ±mÄ±
const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3001';

// âœ… DOÄRU - Merkezi config kullan
import { API_BASE_URL } from '@/lib/config';
const API_URL = `${API_BASE_URL}/api`;
fetch(`${API_BASE_URL}/api/cariler`);
```

**Neden?**
- `config.ts` hem local hem production'da otomatik Ã§alÄ±ÅŸÄ±r
- Build-time deÄŸil runtime'da URL belirlenir
- Tek noktadan yÃ¶netim

---

## ğŸ”Œ Entegrasyonlar

### Aktif
- **ihalebul.com** - Puppeteer scraper (login + pagination)
- **Gemini AI** - DÃ¶kÃ¼man OCR + analiz
- **Claude AI** - KonuÅŸma asistanÄ± + dÃ¶kÃ¼man analizi

### Planlanan
- **Uyumsoft** - Muhasebe yazÄ±lÄ±mÄ± sync
- **e-Fatura** - GÄ°B entegrasyonu

---

## ğŸ•·ï¸ Scraper Sistemi

### Dosya YapÄ±sÄ±
```
backend/src/scraper/
â”œâ”€â”€ browser-manager.js    # Puppeteer singleton
â”œâ”€â”€ session-manager.js    # Cookie kaydet/yÃ¼kle
â”œâ”€â”€ login-service.js      # ihalebul.com login
â”œâ”€â”€ list-scraper.js       # Liste Ã§ekme + DB upsert
â”œâ”€â”€ document-scraper.js   # DÃ¶kÃ¼man/iÃ§erik Ã§ekme
â”œâ”€â”€ logger.js             # Merkezi loglama
â”œâ”€â”€ health.js             # Circuit breaker
â”œâ”€â”€ queue.js              # Job kuyruÄŸu
â””â”€â”€ runner.js             # CLI Ã§alÄ±ÅŸtÄ±rÄ±cÄ±
```

### API Endpoint'leri
```bash
# Scraper
GET  /api/scraper/health              # Sistem durumu
GET  /api/scraper/stats               # Ä°statistikler
POST /api/scraper/trigger             # Manuel scraping
POST /api/scraper/add-tender          # URL ile ihale ekle
POST /api/scraper/fetch-documents/:id # Tek ihale dÃ¶kÃ¼man Ã§ek (on-demand)
GET  /api/scraper/check-documents/:id # DÃ¶kÃ¼man durumu kontrol
POST /api/scraper/cleanup-documents   # TÃ¼m baÅŸarÄ±sÄ±z dÃ¶kÃ¼manlarÄ± temizle
POST /api/scraper/cleanup-tender/:id  # Tek ihale iÃ§in temizlik

# DÃ¶kÃ¼man Ä°ndirme
GET  /api/tender-docs/:id/download-status    # Ä°ndirme durumu (failed dahil)
POST /api/tender-docs/:id/download-documents # DÃ¶kÃ¼man indir + ZIP aÃ§ (otomatik cleanup)
```

### KullanÄ±m
```javascript
// URL ile ihale ekleme
const res = await fetch(`${API_BASE_URL}/api/scraper/add-tender`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ url: 'https://ihalebul.com/tender/123456' })
});

// Tek ihale iÃ§in dÃ¶kÃ¼man Ã§ekme (on-demand)
await fetch(`${API_BASE_URL}/api/scraper/fetch-documents/${tenderId}`, {
  method: 'POST'
});

// DÃ¶kÃ¼man durumu kontrol
const status = await fetch(`${API_BASE_URL}/api/tender-docs/${tenderId}/download-status`);
// Response: { pendingTypes, downloadedTypes, failedTypes, hasFailedDownloads, isComplete }

// DÃ¶kÃ¼manlarÄ± indir (failed olanlarÄ± otomatik temizler, ZIP'leri aÃ§ar)
await fetch(`${API_BASE_URL}/api/tender-docs/${tenderId}/download-documents`, {
  method: 'POST'
});
```

### Production NotlarÄ±
- Chromium kurulumu gerekli: `snap install chromium`
- `.env`'de `PUPPETEER_EXECUTABLE_PATH=/snap/bin/chromium`
- Session dosyasÄ±: `backend/storage/session.json` (.gitignore'da olmalÄ±)

---

## âš ï¸ Ã–nemli Notlar

1. **TÃ¼rkÃ§e Karakter:** TÃ¼m string iÅŸlemlerinde UTF-8
2. **Tarih Format:** ISO 8601 (YYYY-MM-DD)
3. **Para Birimi:** TRY (TÃ¼rk LirasÄ±)
4. **Timezone:** Europe/Istanbul
5. **Decimal Hassasiyet:** 2 basamak (para), 3 basamak (miktar)

---

## ğŸš« YapÄ±lmamasÄ± Gerekenler

1. Raw SQL'de string concatenation (SQL injection riski)
2. Hardcoded credentials (.env kullan)
3. console.log production'da (winston logger kullan)
4. Senkron dosya iÅŸlemleri (async kullan)
5. Global state (component-level state tercih)
6. **Hardcoded API URL'ler (`localhost:3001`)** - `API_BASE_URL` kullan!
7. **Tailwind CSS kullanma** - Mantine kullan!
8. **require/module.exports** - ES Modules import/export kullan!
9. **NextAuth kullanma** - Custom AuthContext kullan!

---

## ğŸ“ Commit MesajÄ± FormatÄ±

```
feat: Yeni Ã¶zellik eklendi
fix: Bug dÃ¼zeltmesi
refactor: Kod iyileÅŸtirmesi
docs: DokÃ¼mantasyon
chore: BakÄ±m iÅŸleri
```

---

## ğŸ¯ Ã–ncelikli GeliÅŸtirme AlanlarÄ±

1. **Stok YÃ¶netimi** - Depo bazlÄ± takip
2. **MenÃ¼ Planlama** - ReÃ§ete-gramaj entegrasyonu
3. **Raporlama** - Dashboard ve export
4. **Mobile** - Responsive iyileÅŸtirmeler
